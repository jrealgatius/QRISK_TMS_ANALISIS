---
title: "Predicció del risc cardiovascular mitjançant dos escales en pacients  amb trastorn mental sever: estudi de cohorts retrospectiu. Informe V/V"
author: "Jordi Real" 
website: "https://github.com/USR-DAPCAT/"
date: "`r format(Sys.time(), '%d %B, %Y')`" 
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    fig_caption: true
    css: logos_css/usr_styles.css
params:
  fitxers_test: TRUE # FALSE #TRUE
  subgrup: "NA"  # "NA" "DG.ALTRES_PSICOTICS" "DG.ESQUIZO" "DG.BIPOLAR_MANIA" "DG.ALTRES_PSICOTICS"
  reevaluar: yes
subtitle: "`r paste0('Part V. GRUP:',params$subgrup)`"
editor_options: 
  markdown: 
    wrap: 72
---



```{=html}
<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"https://www.idiapjgol.org/images/logo.png\" style=\"float: right ;width: 130px;\"/>')
     $head.prepend('<img src=\"https://avatars2.githubusercontent.com/u/57066591?s=200&v=4\" style=\"text-align: center;margin:auto;width: 80px;\"/>')
   });
</script>
```
::: {.watermark}
DRAFT
:::

------------------------------------------------------------------------



```{r setup5, include=FALSE,eval=params$reevaluar}

knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, include=T,size="huge")

# Lectura de dades     

library(lubridate)
library(compareGroups)
# library(flexdashboard)
# library(DT)

link_source<-paste0("https://github.com/jrealgatius/Stat_codis/blob/master/funcions_propies.R","?raw=T")
devtools::source_url(link_source)

# source(here::here("codi/global_lectura.R"))
source(here::here("codi/funcions_qrisk.R"))

# Si fitxers_test  carrego fitxers mostra 
# funcions_lectura_dades(params$fitxers_test)

conductor_variables<-here::here("variables_qrisk.xls")


```



```{r lecturaV, eval=params$reevaluar}

if (params$fitxers_test) fitxer_dades<-"dades_test.Rds" else fitxer_dades<-"dades.Rds"
if (params$fitxers_test) fitxer_dades_preexclusions<-"dadestest_preexclusions.Rds" else fitxer_dades_preexclusions<-"dades_preexclusions.Rds"

dades<-readRDS(here::here("dades",fitxer_dades)) %>% netejar_espais()
dades_preexclusions<-readRDS(here::here("dades",fitxer_dades_preexclusions)) %>% netejar_espais()


dades<-criteris_exclusio(dades,conductor_variables,sheet="exclusions",criteris = "exclusio1")

conductor_variables<-here::here("variables_qrisk.xls")

# Aplicar exclusions
dades<-dades %>% criteris_exclusio(dades,taulavariables=conductor_variables,sheet="exclusions",
                           criteris = "exclusio3")


# Filtrar si hi ha analisis de subgrups
parametre_subgrup<-params$subgrup
if (params$subgrup!="NA") dades<-dades %>% filter(!!sym(parametre_subgrup)=="Yes")

```


```{r}


llistaevents<-extreure.variables("events",conductor_variables)
llista_temps<-extreure.variables("t_event",conductor_variables)

```


# 5.1 Hazard ratio per cada event cardiovascular per QRISK3 i Regicor (global i per sexe)

-   Es seleccionen de dades completes en ambdos indicadors (Qrisk &
    Regicor)
-   Curves ROC y AUC's per cada outcome

```{r output5, eval=TRUE,message=T, warning=FALSE, include=T, echo=FALSE,size="huge", results='asis',out.width="150%"}

# genera_output

# llistaevents[1]
# llista_temps[1]
# 
# dt_temp<-dt_temp %>% filter(regicor>=0 & QRISK3_2017>=0)
# genera_output_HR(llistaevents[2],llista_temps[4],dt_temp)


# Filtro dt_temp completes de REGICOR + RQrisk

dt_temp<-dades %>% filter(regicor>=0 & QRISK3_2017>=0)

purrr::map2(llistaevents,llista_temps,~genera_output_HR(.x,.y,dt_temp)) %>% invisible()



# genera_output_HR(llistaevents[4],llista_temps[4],dt_temp)



```

```{r generotaulaHR, include=F}

dt_temp<-dades %>% filter(regicor>=0 & QRISK3_2017>=0)

taula_HR_grup<-function(x_event="EV.CVD",x_temps="EV.CVD_temps",dt=dt_temp,grup="sexe") {
  split(dt,dt[grup]) %>% map_df(~taula_HR(x_event=x_event,x_temps,.x),.id="grup")}



```

# 5.2 Taula resum de hazard ratios per cada event per QRISK3 i Regicor, global i per sexe

```{r,results="asis"}

dt_temp<-dades %>% filter(regicor>=0 & QRISK3_2017>=0)

map2_df(llistaevents,llista_temps,~taula_HR(.x,.y,dt_temp)) %>% 
  kableExtra::kable(caption = "Taula HR per event",digits = 3) %>% kableExtra::kable_styling()

# Estratificat per sexe 
# taula_HR_grup(x_event="EV.CVD",x_temps="EV.CVD_temps",dt=dt_temp,grup="sexe")

map2_df(llistaevents,llista_temps,~taula_HR_grup(.x,.y,dt_temp,grup="sexe")) %>% 
  kableExtra::kable(caption = "Taula HR per event estratificat per sexe",digits = 3) %>% kableExtra::kable_styling()

gc()

```


# 6. AUC resum global i per sexe

```{r}

dt_temp<-dades %>% filter(regicor>=0 & QRISK3_2017>=0)

dt_taula1<-llistaevents %>% map_df(~taula_AUC_R2(.x,dt=dt_temp),.id="Event")

# Per sexe 
dt_taula2<-llistaevents %>% map_df(~taula_AUC_R2_grup(.x,dt=dt_temp,grup = "sexe"),.id="Event")

dt_taula1 %>% kable(caption = "AUC resum global") %>% kableExtra::kable_classic_2()

dt_taula2 %>% kable(caption = "AUC resum per sexe") %>% kableExtra::kable_classic_2()


```

# 7. Models de regressió ajustats de riscos proporcionals de Cox

-   S'ha fet exclusivament amb la N de participants que tenim calculat
    Qrisk i regicor
-   S'ha afegit models amb variabes recodificades

```{r models, results="asis"}

# formulaCOX("model1",event = llistaevents[1],temps = llista_temps[1], a="regicor", taulavariables = conductor_variables) %>% coxph(data=dades) %>% 
#   sjPlot::tab_model()

dt_temp<-dades %>% filter(regicor>=0 & QRISK3_2017>=0)


# Actualitzar llista d'events a processar
events_a_noprocesar<-dt_taula1 %>% filter(is.na(AUC.qrisk)) %>% select(Event) %>% as.character()
llistaevents<-llistaevents[which(llistaevents!=events_a_noprocesar)]
llista_temps<-llista_temps[which(llistaevents!=events_a_noprocesar)]

map2(llistaevents,llista_temps,~formulaCOX("model1",event = .x,temps = .y, a="regicor", taulavariables = conductor_variables)) %>% 
  map(~coxph(.x,data=dt_temp)) %>% 
  sjPlot::tab_model(title = "Modelos de regressión de Cox ajustados. Regicor ajustado")

map2(llistaevents,llista_temps,~formulaCOX("model1",event = .x,temps = .y, a="regicor.cat", taulavariables = conductor_variables)) %>% 
  map(~coxph(.x,data=dt_temp)) %>% 
  sjPlot::tab_model(title = "Modelos de regressión de Cox ajustados. Regicor ajustado")

map2(llistaevents,llista_temps,~formulaCOX("model1",event = .x,temps = .y, a="regicor_catQ", taulavariables = conductor_variables)) %>%   map(~coxph(.x,data=dt_temp)) %>% 
  sjPlot::tab_model(title = "Modelos de regressión de Cox ajustados. Regicor ajustado")


map2(llistaevents,llista_temps,~formulaCOX("model1",event = .x,temps = .y, a="QRISK3_2017", taulavariables = conductor_variables)) %>% 
  map(~coxph(.x,data=dt_temp)) %>% 
  sjPlot::tab_model(title = "Modelos de regressión de Cox ajustdos. Qrisk ajustado")

map2(llistaevents,llista_temps,~formulaCOX("model1",event = .x,temps = .y, a="QRISK3_2017.cat", taulavariables = conductor_variables)) %>% 
  map(~coxph(.x,data=dt_temp)) %>% 
  sjPlot::tab_model(title = "Modelos de regressión de Cox ajustdos. Qrisk ajustado")

map2(llistaevents,llista_temps,~formulaCOX("model1",event = .x,temps = .y, a="QRISK3_2017_catQ", taulavariables = conductor_variables)) %>% 
  map(~coxph(.x,data=dt_temp)) %>% 
  sjPlot::tab_model(title = "Modelos de regressión de Cox ajustdos. Qrisk ajustado")



```

```{r,include=F}

# 4. Descriptiva escales de risk global y per diferents tipus de TMS

dt_temp<-dades %>% filter(regicor>=0 & QRISK3_2017>=0)

varsTMS<-extreure.variables("TMS",conductor_variables)

formu<-formula.text("REGICOR",y="DG.ESQUIZO",taulavariables = conductor_variables)

descrTable(formu,dt_temp, include.miss = T,show.n = T, show.all = T) %>% 
  export2md()

descrTable(formu,dt_temp, method = 2,Q1=0, Q3=1,show.n = T, show.all = T) %>% 
    export2md()


formu<-formula.text("REGICOR",y="DG.ESQUIZO",taulavariables = conductor_variables)

descrTable(formu,dt_temp, include.miss = T,show.n = T, show.all = T) %>% 
  export2md()

descrTable(formu,dt_temp, method = 2,Q1=0, Q3=1,show.n = T, show.all = T) %>% 
    export2md()


formu<-formula.text("REGICOR",y="DG.BIPOLAR_MANIA",taulavariables = conductor_variables)

descrTable(formu,dt_temp, include.miss = T,show.n = T, show.all = T) %>% 
  export2md()

descrTable(formu,dt_temp, method = 2,Q1=0, Q3=1,show.n = T, show.all = T) %>% 
    export2md()


formu<-formula.text("REGICOR",y="DG.ALTRES_PSICOTICS",taulavariables = conductor_variables)

descrTable(formu,dt_temp, include.miss = T,show.n = T, show.all = T) %>% 
  export2md()

descrTable(formu,dt_temp, method = 2,Q1=0, Q3=1,show.n = T, show.all = T) %>% 
    export2md()


formu<-formula.text("REGICOR",y="DG.DEPRESSIO_GREU",taulavariables = conductor_variables)

descrTable(formu,dt_temp, include.miss = T,show.n = T, show.all = T) %>% 
  export2md()

descrTable(formu,dt_temp, method = 2,Q1=0, Q3=1,show.n = T, show.all = T) %>% 
    export2md()


```


&nbsp;
<hr />
<p style="text-align: center;">A work by $Jordi Real$ </a></p>
<p style="text-align: center;">$Llepali System$ </a></p>
<p style="text-align: center;"><span style="color: #808080;"><em><https://github.com/USR-DAPCAT/></em></span></p>


