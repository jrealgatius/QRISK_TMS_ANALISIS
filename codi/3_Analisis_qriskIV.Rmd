---
title: "Predicció del risc cardiovascular mitjançant dos escales en pacients  amb trastorn mental sever: estudi de cohorts retrospectiu. Informe IV/V"
author: "Jordi Real" 
website: "https://github.com/USR-DAPCAT/"
date: "`r format(Sys.time(), '%d %B, %Y')`" 
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    fig_caption: true
    css: logos_css/usr_styles.css
params:
  fitxers_test: TRUE # FALSE #TRUE
  subgrup: "NA"  # "NA" "DG.ALTRES_PSICOTICS" "DG.ESQUIZO" "DG.BIPOLAR_MANIA" "DG.ALTRES_PSICOTICS"
  reevaluar: yes
subtitle: "`r paste0('Part IV. GRUP:',params$subgrup)`"
editor_options: 
  markdown: 
    wrap: 72
---



```{=html}
<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"https://www.idiapjgol.org/images/logo.png\" style=\"float: right ;width: 130px;\"/>')
     $head.prepend('<img src=\"https://avatars2.githubusercontent.com/u/57066591?s=200&v=4\" style=\"text-align: center;margin:auto;width: 80px;\"/>')
   });
</script>
```
::: {.watermark}
DRAFT
:::

------------------------------------------------------------------------



```{r setup4, include=FALSE,eval=params$reevaluar}


knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, include=T,size="huge")

# Lectura de dades     

library(lubridate)
library(compareGroups)
# library(flexdashboard)
# library(DT)

link_source<-paste0("https://github.com/jrealgatius/Stat_codis/blob/master/funcions_propies.R","?raw=T")
devtools::source_url(link_source)

# source(here::here("codi/global_lectura.R"))
source(here::here("codi/funcions_qrisk.R"))

# Si fitxers_test  carrego fitxers mostra 
# funcions_lectura_dades(params$fitxers_test)

conductor_variables<-here::here("variables_qrisk.xls")


```



```{r lecturaIV,eval=params$reevaluar}
if (params$fitxers_test) fitxer_dades<-"dades_test.Rds" else fitxer_dades<-"dades.Rds"
if (params$fitxers_test) fitxer_dades_preexclusions<-"dadestest_preexclusions.Rds" else fitxer_dades_preexclusions<-"dades_preexclusions.Rds"

dades<-readRDS(here::here("dades",fitxer_dades)) %>% netejar_espais()
dades_preexclusions<-readRDS(here::here("dades",fitxer_dades_preexclusions)) %>% netejar_espais()


dades<-criteris_exclusio(dades,conductor_variables,sheet="exclusions",criteris = "exclusio1")

conductor_variables<-here::here("variables_qrisk.xls")

# Aplicar exclusions
dades<-dades %>% criteris_exclusio(dades,taulavariables=conductor_variables,sheet="exclusions",
                           criteris = "exclusio3")


# Filtrar si hi ha analisis de subgrups
parametre_subgrup<-params$subgrup
if (params$subgrup!="NA") dades<-dades %>% filter(!!sym(parametre_subgrup)=="Yes")

```


```{r}


llistaevents<-extreure.variables("events",conductor_variables)
llista_temps<-extreure.variables("t_event",conductor_variables)

```


# 4.6. Descriptiva d'events i taxes d'incidència estratificades per grup Medea x sexe

-   Només event CV

```{r apartat4.6., include=TRUE}
# Generar grup de edad

dt_temp<-dades %>% filter(regicor>=0 & QRISK3_2017>=0)

dt_temp<-dt_temp %>% mutate(edat_grup=Hmisc::cut2(edat,g=10), 
                            agrupacio=paste0(sexe,": ",qmedea))

# Summary events estratificat per Sexe
dt_temp %>% split(.$agrupacio,drop = T) %>% map_df(
  function(dt=.x) map2_df(llistaevents[1],llista_temps[1],~resum_events_v3(dt,evento=.x,temps=.y,valorevent=1),.id="event"),
  .id="Grup") %>%
  etiquetar_taula(camp="event",taulavariables = conductor_variables) %>%
  kable(digits = 4,caption = "Descriptiva d'esdeventiments per sexe i medea") %>% kableExtra::kable_styling()



# Generar grup de edad
dades<-dades %>% mutate(edat_grup=Hmisc::cut2(edat,g=10), 
                            agrupacio=paste0(sexe,": ",qmedea))

# Summary events estratificat per Sexe
dades %>% split(.$agrupacio,drop = T) %>% map_df(
  function(dt=.x) map2_df(llistaevents[1],llista_temps[1],~resum_events_v3(dt,evento=.x,temps=.y,valorevent=1),.id="event"),
  .id="Grup") %>%
  etiquetar_taula(camp="event",taulavariables = conductor_variables) %>%
  kable(digits = 4,caption = "Descriptiva d'esdeventiments per sexe i medea (Pob TMS)") %>% kableExtra::kable_styling()

```


# 4.7. Descriptiva d'events i taxes d'incidència estratificades per grup Ruralitat x sexe

-   Només ECV

```{r apartat4.7}
# Generar grup de edad

dt_temp<-dades %>% filter(regicor>=0 & QRISK3_2017>=0)
dt_temp<-dt_temp %>% mutate(edat_grup=Hmisc::cut2(edat,g=10), 
                            agrupacio=paste0(sexe,": ",ruralitat))

llistaevents<-extreure.variables("events",conductor_variables)
llista_temps<-extreure.variables("t_event",conductor_variables)

# Summary events estratificat per Sexe
dt_temp %>% split(.$agrupacio,drop = T) %>% map_df(
  function(dt=.x) map2_df(llistaevents[1],llista_temps[1],~resum_events_v3(dt,evento=.x,temps=.y,valorevent=1),.id="event"),
  .id="Grup") %>%
  etiquetar_taula(camp="event",taulavariables = conductor_variables) %>%
  kable(digits = 4,caption = "Descriptiva d'esdeventiments per sexe i ruralitat") %>% kableExtra::kable_styling()



# Generar grup de edad
dades<-dades %>% mutate(edat_grup=Hmisc::cut2(edat,g=10), 
                            agrupacio=paste0(sexe,": ",ruralitat))

# Summary events estratificat per Sexe
dades %>% split(.$agrupacio,drop = T) %>% map_df(
  function(dt=.x) map2_df(llistaevents[1],llista_temps[1],~resum_events_v3(dt,evento=.x,temps=.y,valorevent=1),.id="event"),
  .id="Grup") %>%
  etiquetar_taula(camp="event",taulavariables = conductor_variables) %>%
  kable(digits = 4,caption = "Descriptiva d'esdeventiments per sexe i ruralitat (Pob TMS)") %>% kableExtra::kable_styling()


```


&nbsp;
<hr />
<p style="text-align: center;">A work by $Jordi Real$ </a></p>
<p style="text-align: center;">$Llepali System$ </a></p>
<p style="text-align: center;"><span style="color: #808080;"><em><https://github.com/USR-DAPCAT/></em></span></p>


