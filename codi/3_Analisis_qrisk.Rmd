---
title: "Predicció del risc cardiovascular mitjançant dos escales en pacients  amb trastorn mental sever: estudi de cohorts retrospectiu"
author: "Jordi Real" 
website: "https://github.com/USR-DAPCAT/"
date: "`r format(Sys.time(), '%d %B, %Y')`" 
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    fig_caption: true
    css: logos_css/usr_styles.css
params:
  fitxers_test: TRUE # FALSE #TRUE
  subgrup: "NA"  # "NA" "DG.ALTRES_PSICOTICS" "DG.ESQUIZO" "DG.BIPOLAR_MANIA" "DG.ALTRES_PSICOTICS"
subtitle: "`r params$subgrup`"
editor_options: 
  markdown: 
    wrap: 72
---



```{=html}
<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"https://www.idiapjgol.org/images/logo.png\" style=\"float: right ;width: 130px;\"/>')
     $head.prepend('<img src=\"https://avatars2.githubusercontent.com/u/57066591?s=200&v=4\" style=\"text-align: center;margin:auto;width: 80px;\"/>')
   });
</script>
```
::: {.watermark}
DRAFT
:::

------------------------------------------------------------------------

# Objectiu

## Principal

-   Estudiar si l'estimació del risc cardiovascular mitjançant les
    escales QRISK3 i REGICOR en la població TMS prediu l'aparició
    d'esdeveniments cardiovasculars i avaluar les diferències entre les
    dues escales.

# Estat

## Actualizaciones

> 07 / Juliol / 2022

- Verifiació de de creació de variable fàrmacs hipolipemiants.
- S'elimina del 1er flow chart Depressió recurrent. S'exclouen de Grup TMS analitzat
- S'inclou en flow-chart i exclusions Antecedent ECV (Que inclou IAM,AVC i CI)



> 09 / Juny / 2022

- Exclusions: 
  - Tractats amb Hipolipemiants (Prescrita o dispensada)
  - Depressió recurrent

- Reclasificació de TMS:  Diagnostic TMS en basal o, (Tractament antipsicòtic basal i TMS en qualsevol moment)



> 21 / Gener / 2022

- Generació de variables TMS Post
- Reclassifiació de TMS segons tractament antipsicotic si edat=<65
- Comprovat que no hi ha cap amb pacient amb demència
- Tractar tabaquisme missings com a missings, Regicor i QRISK3

> 11/ Juny / 2021

- Treure volum de pacients tenen la data de diagnòstic del TMS posterior a la data de càlcul del RCV i/o data de l’event (global i per subgrup Dx) i, en funció d’això, valorarem si cal fer subanàlisi d’aquest grup per poder-ho justificar a la discussió. Sobretot per l’esquizofrènia.

- Generar esdeveniment nou AIT+AVC 

> 25 / Febrer 

-   Incidencia per població TMS / població completa amb regicor-Qrisk

-   Kappa recalculat 

-   ROC per edad y sexe


> Febrer / 2020

-   Fer els anàlisis per grups d'edat amb els quatre grups d'edat (cada
    10 anys).

-   Recodificar REGICOR en dos categories: \<10% i \>=10% i refer
    anàlisis amb aquestes dues categories

-   Fer corbes ROC i AUC per grups d'edat i sexe (12 corbes: 4 grups
    d'edat total, 4 grups d'edat homes, 4 grups d'edat dones) pel global
    d'events, per CI i per AVC.

-   Descriptiva d'events i taxes d'incidència estratificades per
    categories de Regicor i Qrisk (\<10% i \>=10%).

-   Calcular concordança REGICOR 2 categories vs QRISK 2 categories
    (taula 2x2, índex kappa).

-   Repetir tots els anàlisis amb els canvis anteriors pel global de TMS
    i per cada subgrup diagnòstic.

## Fet

> Gener / 2020

✓ Agregació de variables: En periode finestra si en el període finestra
hi ha més d'un valor, fer la mitjana dels valors que hi hagi <br/> ✓
Grups d'edat: Els del Regicor: 35-44 / 45-54 / 55-64 / 65-74

> Desembre / 2020

✓ Anàlisis d'historics de fármacs Antipsicotics en població no
classificada de TMS <br/> ✓ Models de regressió de COX ajustats <br/>

> Novembre / 2020

✓ Anàlisis descriptiu per subgrups d'edat <br/> ✓ Taxa d'incidencia + IC
per grups d'edat, sexe i Medea <br/> ✓ ROC i AUC i HR per event i sexe
<br/> ✓ Generar taules resum <br/> ✓ Eliminar solapaments de TMS <br/> ✓
Revisar càlcul de QRisk (Nacionalitat i Tabac) <br/> ✓ Correlació
Regicor calculat vs Regicor directe E-Cap <br/> ✓ Establir rang de
valors valids de variables numèriques: <br/>

-   Cholesterol/HDL ratio: 1.0-11.0 ; resta blank
-   SBP: 70-210
-   Standard deviation of SBP: 0.0- 40.0
-   Talla: 140-210
-   Pes: 40-180

> Desembre /2020

✓ Descriptiva de pacients≤65 + tractament antipsicòtic sense diagnòstic
TMS

> Novembre / 2020

✓ Anàlisis de solapaments per subgrups TMS <br/> ✓ Comparació de models
es seleccionen de dades completes en ambdos indicadors (Qrisk & Regicor)
✓ Afegida curva ROC i AUC en la comparativa d'indicadors de
discriminació(Qrisk & Regicor)

> Octubre/2020

✓ Es descarta aparellament dirigint analisis objectiu principal <br/> ✓
Característiques basals de la població TMS (global i per sexe) <br/> ✓
Taxes d'incidència de malaltia cardiovascular per 1000 persones-any
(global i per sexe) <br/> ✓ Hazard ratio ajustada de malaltia
cardiovascular per QRISK3 i Regicor (global i per sexe) <br/> ✓ Comparar
la capacitat de discriminació de cada model/escala (AIC, R2) <br/>

> Septembre/2020

✓ Recalcular fàrmacs dispensats: Les N són iguals per a tots els
fàrmacs. Pendent revisar <br/> ✓ Veure % de pacients TMS (total
població) que tenen calculat el QRISK <br/> ✓ Fer aparellament (selecció
no TMS) <br/>

Aparellament segons protocol: - Edat, sexe, metge assignat i centre de
referència amb una proporció de casos i controls de 1:2 - Pacient haurà
de constar com actiu a la data d'inclusió del TMS

-   S'aparella per densitat d'incidencia
-   Codi únic per professional

> 20-28/07/2020

✓ Cortis: Cal que sigui prescripció crònica: 6 mesos o més de
prescripció o bé 6 envasos en l'últim any abans de la inclusió <br/> ✓
Diabetis: Els que són DM que no estan classificats ni com tipus I ni com
tipus II (DM_ALTRES només condicionat a fàrmacs antidiabètics), cal
classificar-los com a tipus II <br/>

✓ Actualització de resultats <br/>

✓ Taules comparatives per tipus de TMS <br/>

> 6/07/2020

✓ Llistat de pacients TMS amb info QRISK <br/> ✓ Descriptiva -
comparativa de grups <br/>

> 26/06/2020

✓ Aplicar exclusions <br/> ✓ Etiquetar variables <br/> ✓ Depuració rang
de valors vàlids (recode_to_missings) <br/> ✓ Descriptiva - comparativa
de grups <br/>

> 09/06/2020

✓ Revisar diagnostic DM <br/> ✓ Calcular Malaltia renal crònica en
funció de CKDEPI <br/> ✓ Actualitzar QRISK en funció de <br/> ✓ Calcular
SD de PAS (Últim any) <br/> ✓ Classificació de TMS segons seguiment
<br/> ✓ Actualització de resultats <br/>

> 07/06/2020

✓ Generada data d'inclusió (dtindex) segons determinació Regicor / Qrisk
més propera (2007-2010) <br/> ✓ Càlcul regicor <br/> ✓ Càlcul QRISK
<br/> ✓ Nova agregació <br/>

> 03/2020

✓ Afegits nous agregadors <br/> ✓ Lectura de fitxers <br/> ✓ Generació
de conductors <br/> ✓ Agregació <br/> ✓ Exploratori <br/>

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, include=T,size="huge")

# Lectura de dades     

library(lubridate)
library(compareGroups)
library(QRISK3)
# library(flexdashboard)
library(DT)


link_source<-paste0("https://github.com/jrealgatius/Stat_codis/blob/master/funcions_propies.R","?raw=T")
devtools::source_url(link_source)

source(here::here("codi/global_lectura.R"))
source(here::here("codi/funcions_qrisk.R"))

# Si fitxers_test  carrego fitxers mostra 
funcions_lectura_dades(params$fitxers_test)

conductor_variables<-here::here("variables_qrisk.xls")


```


# Lectura de dades

```{r lectura}
if (params$fitxers_test) fitxer_dades<-"dades_test.Rds" else fitxer_dades<-"dades.Rds"
if (params$fitxers_test) fitxer_dades_preexclusions<-"dadestest_preexclusions.Rds" else fitxer_dades_preexclusions<-"dades_preexclusions.Rds"

dades<-readRDS(here::here("dades",fitxer_dades)) %>% netejar_espais()
dades_preexclusions<-readRDS(here::here("dades",fitxer_dades_preexclusions)) %>% netejar_espais()


```


```{r lectura2, eval=FALSE}

dt_codis_antisic<-read_conductor(here::here("cataleg_qrisk.xls")) %>% 
  filter(agr=="APSIC") %>% 
  select(cod,agr)

# Lectura facturats i prescrits de 
dt_facturats<-Inf %>% LLEGIR.FX.FACTURATS() 
dt_prescrits<-Inf %>% LLEGIR.FX.PRESCRITS()

dt_facturats_APSIC<-
  dt_facturats %>% 
  semi_join(dt_codis_antisic,by="cod") %>% 
  semi_join(mutate(dades,idp=as.character(idp)),by="idp") 

dt_prescrits_APSIC<-
  dt_prescrits %>% 
  semi_join(dt_codis_antisic,by="cod") %>% 
  semi_join(mutate(dades,idp=as.character(idp)),by="idp") 

rm(dt_facturats)
rm(dt_prescrits)


# Llegeix cataleg_qrisk.xls 
dt_cataleg_TMS<-
  read_excel(here::here("cataleg_qrisk.xls")) %>% 
  filter(!is.na(TMS)) %>% select(cod,TMS_sub,TMS)

# Filtrar problemes_TMS TMS's 
dt_problemes_TMS<-
  Inf %>% LLEGIR.PROBLEMES() %>% select(-agr) %>% 
  semi_join(dt_cataleg_TMS,by="cod") %>% 
  left_join(dt_cataleg_TMS,by="cod")


```


# Diagrames d'exclusions

```{r diagrames}

criteris_exclusio_diagrama(dades,conductor_variables,sheet="exclusions",
                           grups = "DG.TMS",criteris = "exclusio2",etiquetes = "descripcio",ordre="ordre",sequencial = F)

criteris_exclusio_diagrama(dades_preexclusions,conductor_variables,sheet="exclusions",
                           criteris = "exclusio1",ordre="ordre",etiquetes = "lab_exc",sequencial = F)


dades<-criteris_exclusio(dades,conductor_variables,sheet="exclusions",criteris = "exclusio1")

```


```{r preparacio, include=FALSE}


# Preparació residual ECV i temps

# Event CVD 
dades<-dades %>% mutate(EV.CVD=pmin(EV.CI,EV.AVC_ISQ,EV.AIT,na.rm = T))

# Calculo variable temps lliure d'EVENT i dicotomitzo variables event
dades<-
  dades %>% mutate_at(vars(starts_with("EV.")),list("temps"=~((ymd(.)-ymd(dtindex)) %>% as.numeric))) %>% 
          mutate_at(vars(ends_with("_temps")),~if_else(is.na(.),(ymd(sortida)-ymd(dtindex)) %>% as.numeric,.)) %>%
          mutate_at(vars(ends_with("_temps")),~./365.25) %>%
          mutate_at(vars(starts_with("EV.") & !ends_with("_temps")),~if_else(.>0,1,0,missing = 0))

# Verificació
# dades %>% select(extreure.variables("events",conductor_variables))

# Exitus durant seguiment
dades<-dades %>% mutate(exitus=if_else(situacio=="D",1,0))


# Generar variable que computi combinacions de variables 

dades<-
  comptar_valors(dades,variables =extreure.variables("TMS",conductor_variables),"Yes") %>% 
  rename(N_TMS=num_valors)

# grups d'edat
dades<-dades %>% recodificar(conductor_variables,criteris = "recode")

# mes grups d'edat
dades<-dades %>% mutate(edat_grup=Hmisc::cut2(edat,g=10),
                        agrupacio=paste0(sexe,": ",edat.cat7))


```



```{r, include=FALSE, eval=FALSE}

# 1 Exploratori

## 1.1. Descriptiva Antipsicotics (Facturats o prescrits en qualsevol moment) en PACIENTS NO TMS 

dt_NOTMS<-dades %>% filter(DG.TMS=="No")

dt_APSIC_resum<-
  dt_facturats_APSIC %>% group_by(idp) %>% slice(1) %>% ungroup() %>% mutate(FX_APSIC=1) %>% select(idp,FX_APSIC)

dt_APSIC_resum<-
  dt_prescrits_APSIC %>% group_by(idp) %>% slice(1) %>% ungroup() %>% mutate(FX_APSIC=1) %>% select(idp,FX_APSIC) %>% 
  bind_rows(dt_APSIC_resum) %>% 
  group_by(idp) %>% slice(1) %>% ungroup()


# Fusionar algun Antipsicotic 
dt_NOTMS<-dt_NOTMS %>% 
  mutate(idp=as.character(idp)) %>% 
  left_join(dt_APSIC_resum,by="idp") %>% 
  mutate(FX_APSIC=if_else(FX_APSIC==1,1,0,missing = 0))


formu<-formula.text("TMS",y="FX_APSIC",taulavariables =  conductor_variables)


dt_NOTMS<-dt_NOTMS %>% 
  mutate(edad=as.numeric((ymd(dtindex)-ymd(dnaix))/365.25)) %>% 
  mutate(edad_grup=if_else(edad>65,"Major 65 anys","Menor o igual 65 anys "))

### Descriptiva dates 
dt_codis_antisic %>% distinct(cod) %>% kable(caption = "Llistat de codis inclosos") %>% kableExtra::kable_styling()

dt_prescrits_APSIC %>% semi_join(dt_NOTMS,by="idp") %>% 
  summarise(N_patients=n_distinct(idp),min(dat),max(dat), N_patients=n_distinct(idp)) %>% kable(caption = "Dates d'històric de prescripcions d'antipsicotics de codis inclosos") %>% kableExtra::kable_styling()

dt_facturats_APSIC %>% semi_join(dt_NOTMS,by="idp") %>%
  summarise(N_patients=n_distinct(idp),min(dat),max(dat)) %>% kable(caption = "Dates d'històric de facturacions d'antipsicotics de codis inclosos") %>% kableExtra::kable_styling()

descrTable(edad_grup~FX_APSIC,data=dt_NOTMS,show.p.overall = F, method = 3,show.all = T) %>% 
  export2md()



```






```{r aplicacio_criteris}
conductor_variables<-here::here("variables_qrisk.xls")

# Aplicació de criteris d'exclusió

# Flow chart
criteris_exclusio_diagrama(dades,taulavariables=conductor_variables,sheet="exclusions",
                           criteris = "exclusio3",ordre="ordre",etiquetes = "lab_exc",sequencial = F)


# Aplicar exclusions
dades<-dades %>% criteris_exclusio(dades,taulavariables=conductor_variables,sheet="exclusions",
                           criteris = "exclusio3")


```

```{r preparacio2,include=FALSE}
# Fer Agrupacions QRisk i regicor 

dades<-dades %>% recodificar2(conductor_variables,"recode2",prefix = "cat",missings = F)

dades<-dades %>% mutate_at(c("QRISK3_2017","regicor"),.funs=list(catQ=~Hmisc::cut2(.,g=3)))

```



```{r Descriptiva_TMS, eval=FALSE, include=FALSE}


## 1.2. Descriptiva de subgrups de TMS i combinacions

# Descriptiva
descrTable(formula.text("TMS","sexe",taulavariables=conductor_variables),data=dades,hide = "No",show.all = T,show.p.overall = F,extra.labels = c("","","")) %>% export2md()

# Desscriptiva de combiacions de TMS
dt_temp<-
  dades %>% filter(N_TMS>1) %>% 
  select(DG.TMS,N_TMS,extreure.variables("TMS",conductor_variables)) %>% 
  tidyr::unite(ES_BI_AL_DEP,extreure.variables("TMS",conductor_variables),sep="_")
 
descrTable(~N_TMS,data=dades,max.xlev = 20, method = 3, Q1=0,Q3=1,extra.labels = c("","","")) %>% 
  export2md(caption = "Summary descriptives table of number of TMS diagnostics")

descrTable(dt_temp,max.xlev = 50, method = 3, Q1=0,Q3=1,extra.labels = c("","","")) %>% 
  export2md()


```

```{r prioritzacio_TMS, include=FALSE}
# Arreglar priorització TMS segons conductor

# Generar TMS excloents segons criteris prioritaris
vars_TMS<-extreure.variables("TMS",conductor_variables)

# Ull no estan totes les combinacions (només les de la Base de dades)
combi_TMS <- read_conductor(conductor_variables,sheet="solapaments_TMS") %>% 
  tidyr::unite(ES_BI_AL_DEP,vars_TMS,sep="_") %>% 
  tidyr::unite(ES_BI_AL_DEP_nou,paste0(vars_TMS,2),sep="_") %>% 
  tidyr::separate(ES_BI_AL_DEP_nou,vars_TMS,sep="_") %>% 
  select(ES_BI_AL_DEP,vars_TMS)

# Unir a dades solapaments arreglats de diagnostics
dades<-dades %>% 
  tidyr::unite(ES_BI_AL_DEP,vars_TMS,sep="_") %>% 
  left_join(combi_TMS)

# Desscriptiva de combiacions de TMS
dt_temp<-
  dades %>% filter(N_TMS>1) %>% 
  select(DG.TMS,N_TMS,extreure.variables("TMS",conductor_variables)) %>% 
  tidyr::unite(ES_BI_AL_DEP,extreure.variables("TMS",conductor_variables),sep="_")
 
descrTable(dt_temp,max.xlev = 50, method = 3, Q1=0,Q3=1,extra.labels = c("","","")) %>% 
  export2md()


```


```{r filtrar_subgrups}

# Filtrar si hi ha analisis de subgrups
parametre_subgrup<-params$subgrup
if (params$subgrup!="NA") dades<-dades %>% filter(!!sym(parametre_subgrup)=="Yes")



```

```{r}
# Categorització de qmedea
dades<-dades %>% mutate(qmedea=ifelse(qmedea=="","NA",qmedea)) 

dades<-etiquetar_valors(dades,conductor_variables,fulla="value_label")


```


```{r}

dades<-etiquetar(dades,taulavariables = conductor_variables)

```

```{r, include=FALSE, eval=FALSE}


# Verificació d'aparellament 

compareGroups::descrTable(DG.TMS~sexe+dnaix,data=dades,extra.labels = c("","","")) %>% 
  export2md(caption = "Descriptiva verificació d'aparellament")

compareGroups::descrTable(~n_match,data=dades,method = 3,extra.labels = c("","","")) %>% 
  export2md(caption = "Nombre de controls per grup a risc")


```




```{r, eval=FALSE}


## 1.3. Descriptiva de subgrups TMS classificats després de la data d'inclusió  

# Treure volum de pacients tenen la data de diagnòstic del TMS posterior a la data de càlcul del RCV (global i per subgrup Dx) i, en funció d’això....



# Selecciono dates minimes de cada subgrup

dt_temp<-dt_problemes_TMS %>% group_by(idp,TMS_sub) %>% slice(which.min(dat)) %>% ungroup() %>% 
  select(idp,TMS_sub,dat) 

library(lubridate)
#
dt_temp2<-dades %>% select(idp,grup,dtindex) %>% 
  mutate(idp=as.character(idp),grup,dtindex) %>% 
  left_join(dt_temp,by="idp") %>% 
  mutate(dataTMS_post=if_else(dat>dtindex,1,0),
         dies_post=ifelse(dat>dtindex,ymd(dat)-ymd(dtindex),NA),
         dies_pre=ifelse(dat<=dtindex,ymd(dat)-ymd(dtindex),NA),
         dies=ymd(dat)-ymd(dtindex)) 

# afegir en dades variable indicadora de TMS post
# dades<-dades %>% 
#   left_join(dt_temp2 %>% select(idp,dataTMS_post))

#
dt_temp2<-dt_temp2 %>% 
  summarise(N_pax=n_distinct(idp),
            'post TMS(n)'=sum(dataTMS_post),
            `post TMS(%)`=(`post TMS(n)`/N_pax)*100,
            `Dies (min)`=min(dies_post,na.rm=T),
            `Dies (mediana)`=median(dies_post,na.rm=T),
            `Dies (max)`=max(dies_post,na.rm=T)) %>% 
  mutate(grup="Global")
  

dt_temp3<-
  dades %>% select(idp,grup,dtindex) %>% 
  mutate(idp=as.character(idp),grup,dtindex) %>% 
  left_join(dt_temp,by="idp") %>% 
  mutate(dataTMS_post=if_else(dat>dtindex,1,0),
         dies_post=ifelse(dat>dtindex,ymd(dat)-ymd(dtindex),NA),
         dies_pre=ifelse(dat<=dtindex,ymd(dat)-ymd(dtindex),NA),
         dies=ymd(dat)-ymd(dtindex)) %>% 
  group_by(TMS_sub) %>% 
  summarise(N_pax=n_distinct(idp),
            'post TMS(n)'=sum(dataTMS_post),
            `post TMS(%)`=(`post TMS(n)`/N_pax)*100,
            `Dies (min)`=min(dies_post,na.rm=T),
            `Dies (mediana)`=median(dies_post,na.rm=T),
            `Dies (max)`=max(dies_post,na.rm=T)) %>% 
  rename(grup="TMS_sub")


dt_temp3 %>% bind_rows(dt_temp2) %>% 
  kable(digits = 2, caption = "Nombre i % de subjectes on la data de TMS es posterior a la data d'inclusió, mediana, mínim màxim de temps en dies post inclusio") %>% kableExtra::kable_styling()


# ## Quants events tenen post TMS
# dades %>%
#   filter (EV.AIT==1) %>%
#   select(idp,grup,dtindex,EV.AIT,EV.AIT_temps) %>%
#   mutate(idp=as.character(idp),grup,dtindex) %>%
#   left_join(dt_temp,by="idp") %>% filter(dat>dtindex) %>%
#   mutate(anys_post=as.numeric((ymd(dat)-ymd(dtindex))/365.25)) %>%
#   mutate(Event_post=if_else(anys_post>EV.AIT_temps,1,0))


```

# 1 Anàlisi exploratori

## 1.4. Descriptiva exploratoria

```{r, mensage=F, include=T}

dades<-
  dades %>% mutate(dataTMS_post=pmin(EVTMS.ALTRES_PSICOTICS,EVTMS.BIPOLAR_MANIA,EVTMS.DEPRESSIO_GREU,EVTMS.ESQUIZO,na.rm = T)) %>% 
  mutate(DG.TMS_post=if_else(dataTMS_post>dtindex,"Yes","No",missing = "No")) %>% 
  mutate(dies.TMS_post=(ymd(dataTMS_post)-ymd(dtindex)) %>% as.numeric())


formu<-formula.text("explo",y="",taulavariables = conductor_variables)

descrTable(formu,dades, method = 2,Q1=0, Q3=1,extra.labels = c("","",""),hide = "No") %>% 
  export2md(caption = "Descriptiva exploratoria")
  

# table(dades$qmedea,dades$ruralitat) %>% kable(caption="Medea x Ruralitat") %>% kableExtra::kable_styling()

# table(dades$any_index) %>% kable() %>% kableExtra::kable_styling()

```

## 1.5. Validació de REGICOR calculat versus REGICOR segons Ecap

### Correlació regicor calculat vs regicor Ecap

-   Descriptiva, correlació i plot
-   Llistat mostra de casos

```{r}
descrTable(~REGICOR.valor+regicor,data=dades) %>% 
  export2md(caption = "Descriptiva Baseline")

t.test(dades$REGICOR.valor,dades$regicor) %>% print.AsIs()

cor<-cor.test(dades$REGICOR.valor,dades$regicor) 
kable(cor$estimate,digits = 3) %>% kableExtra::kable_styling() 


dt_temp <- dades %>% filter(!is.na(REGICOR.valor) & !is.na(regicor))
descrTable(~REGICOR.valor+regicor,data=dt_temp) %>% 
  export2md(caption = "Descriptiva Baseline")

ggplot(data=dt_temp,aes(REGICOR.valor,regicor))+ 
  ggplot2::geom_point()


# dt_temp %>% select(idp,REGICOR_ECAP=REGICOR.valor,Regicor_calculat=regicor,extreure.variables("REGICOR",taulavariables = conductor_variables)) %>% filter(idp=="0013d91b55fb03b7e2710f1f6fe358718d73549c") %>% 
#   head() %>% 
#   kable(caption = "Mostra de pacients amb regicor calculat",digits = 1) %>% 
#   kableExtra::kable_styling()



```

# 2. Descriptiva baseline global i per sexe

-   Total població

```{r, include=T}


formu<-formula.text("baseline",y="sexe",taulavariables = conductor_variables)


descrTable(formu,dades,include.miss = F, show.n = T, show.all = T, show.p.overall = T,hide.no = T, extra.labels = c("","",""), 
           hide = "No") %>% 
  export2md(caption = "Descriptiva Baseline")


# N missing

formu<-formula_table1("baseline",y="sexe",taulavariables = conductor_variables)
table1::table1(formu,dades,render.continuous='N', caption="Descriptiva de frequencies")


```

-   Població amb dades completes de Regicor / QRisk

```{r, include=T}

# Filtro dades completes de REGICOR + RQrisk
dt_temp<-dades %>% filter(regicor>=0 & QRISK3_2017>=0)


formu<-formula.text("baseline",y="sexe",taulavariables = conductor_variables)

descrTable(formu,dt_temp,include.miss = T, show.n = T, show.all = T, show.p.overall = F,extra.labels = c("","",""),hide = "No") %>% 
  export2md(caption = "Descriptiva Baseline")



```

# 3. Descriptiva escales de risk global y per sexe

```{r, include=T}

dt_temp<-dades %>% filter(regicor>=0 & QRISK3_2017>=0)

formu<-formula.text("REGICOR",y="sexe",taulavariables = conductor_variables)
descrTable(formu,dt_temp, include.miss = T,show.n = T, show.all = T,show.p.overall = F,extra.labels = c("","",""),hide = "No") %>%
  export2md(caption = "Descriptiva exploratoria REGICOR")

descrTable(formu,dt_temp, method = 2,Q1=0, Q3=1,show.n = T, show.all = T,show.p.overall = F,extra.labels = c("","",""),hide = "No") %>%
    export2md(caption = "Descriptiva exploratoria REGICOR")

formu<-formula_table1("REGICOR","sexe",taulavariables = conductor_variables)
table1::table1(formu,data=dt_temp,caption="Descriptiva de Regicor")

formu<-formula.text("QRISK",y="sexe",taulavariables = conductor_variables)

descrTable(formu,dt_temp, include.miss = T,show.n = T, show.all = T,show.p.overall = F,extra.labels = c("","",""),hide = "No") %>% 
  export2md(caption = "Descriptiva exploratoria QRisk")

descrTable(formu,dt_temp, method = 2,Q1=0, Q3=1,show.n = T, show.all = T,show.p.overall = F,extra.labels = c("","",""),hide = "No") %>% 
    export2md(caption = "Descriptiva exploratoria QRisk")


# #
# formu<-formula_table1("QRISK",y="sexe",taulavariables = conductor_variables)
# table1::table1(formu,data=dt_temp)

```

# 3.2 Concordança d'escales REGICOR versus QRISC

```{r, eval=FALSE}

dt_temp<-dades %>% filter(regicor>=0 & QRISK3_2017>=0)

descrTable(~regicor + regicor.cat + QRISK3_2017 + QRISK3_2017.cat,data=dades,method = 2) %>% 
  export2md(caption = "Descriptiva d'escales")

cor<-cor.test(dades$regicor,dades$QRISK3_2017) 
kable(cor$estimate,digits = 3, caption = "Coeficient de correlació de Pearson") %>% kableExtra::kable_styling() 

ggplot(data=dt_temp,aes(regicor,QRISK3_2017))+ 
  ggplot2::geom_point()+
  labs(title = paste0("Scatter plot")) +
  ggplot2::geom_smooth() + ggpubr::stat_cor(method="pearson")

# Per sexe
ggplot(data=dt_temp,aes(regicor,QRISK3_2017))+ 
  ggplot2::geom_point()+
  labs(title = paste0("Scatter plot by sex")) +
  ggplot2::geom_smooth() + ggpubr::stat_cor(method="pearson") +
  facet_grid(~sexe)

# Per grup d'edat
ggplot(data=dt_temp,aes(regicor,QRISK3_2017))+ 
  ggplot2::geom_point()+
  labs(title = paste0("Scatter plot")) +
  ggplot2::geom_smooth() + ggpubr::stat_cor(method="pearson") +
  facet_grid(~edat.cat7)


# Per grup d'edat i sexe
ggplot(data=dt_temp,aes(regicor,QRISK3_2017))+ 
  ggplot2::geom_point()+
  labs(title = paste0("Scatter plot by age and sex")) +
  ggplot2::geom_smooth() + ggpubr::stat_cor(method="pearson") +
  facet_wrap(~sexe+edat.cat7,nrow = 2)


#########       Kappa         ###################

funcio_kappa<-function(dt=dades) {
  k=table(dt$regicor.cat,dt$QRISK3_2017.cat) %>% psych::cohen.kappa()
  IC1=k$confid[1,1]
  IC2=k$confid[1,3]
  k=k$kappa
  r=cor(dt$regicor,dt$QRISK3_2017, use = "na.or.complete")
  tibble::tibble(kappa=k,IC95inf=IC1,IC95sup=IC2,coef_pearson=r,N=as.numeric(count(dt)))
  }

# 
# Concordance 
kappa<-funcio_kappa()

descrTable(regicor.cat ~ QRISK3_2017 + QRISK3_2017.cat,data=dades,method = 2,show.p.overall = F) %>% 
  export2md(caption = paste0("Concordança: Descriptiva QRisk en funció de nivells de REGICOR. <br/> Kappa = ",round(kappa$kappa,2), ";  IC95:",round(kappa$IC95inf,2),"-",round(kappa$IC95sup,2),"; Coef. Pearson=",round(kappa$coef_pearson,2)))

# datos completos
descrTable(regicor.cat ~ QRISK3_2017 + QRISK3_2017.cat,data=dades,method = 2,show.p.overall = F) %>% 
  export2md(caption = paste0("Concordança: Descriptiva QRisk en funció de nivells de REGICOR. <br/> Kappa = ",round(kappa$kappa,2), ";  IC95:",round(kappa$IC95inf,2),"-",round(kappa$IC95sup,2),"; Coef. Pearson=",round(kappa$coef_pearson,2)))

# Filtro segons dades de regicor + Qrisk
dt_temp<-dades %>% tidyr::drop_na(regicor,QRISK3_2017)
descrTable(regicor.cat ~ QRISK3_2017 + QRISK3_2017.cat,data=dt_temp,method = 2,show.p.overall = F) %>% 
  export2md(caption = paste0("Concordança: Descriptiva QRisk en funció de nivells de REGICOR. dades completes Qrisc+regicor <br/> Kappa = ",round(kappa$kappa,2), ";  IC95:",round(kappa$IC95inf,2),"-",round(kappa$IC95sup,2),"; Coef. Pearson=",round(kappa$coef_pearson,2)))


dades %>% split(.$sexe,drop = T) %>% purrr::map_df(~funcio_kappa(.x),.id="Grup") %>% kable(caption="Kappa per sexe") %>% kableExtra::kable_styling()
dades %>% split(list(.$sexe,.$edat.cat7),drop = T) %>% purrr::map_df(~funcio_kappa(.x),.id="Grup") %>% kable(caption="Kappa per edad i sexe") %>% kableExtra::kable_styling()

```

# 4. Descriptiva d'events i taxes d'incidència estratificades per sexe

- Complete cases Regicor+QRisc: Població amb Regicor i Qrisk calculat
- Pob TMS: Població TMS independetment si tenim Regicor i Qrisk calculat


```{r}

gc()

dt_temp<-dades %>% filter(regicor>=0 & QRISK3_2017>=0)

# Generar resum d'esdeveniments 
# resum_events_v3(dt_temp,evento="EV.CVD",temps="EV.CVD_temps",valorevent=1) 
llistaevents<-extreure.variables("events",conductor_variables)
llista_temps<-extreure.variables("t_event",conductor_variables)

# Summary d'events
map2_df(llistaevents,llista_temps,~resum_events_v3(dt_temp,evento=.x,temps=.y,valorevent=1),.id="event") %>% 
  etiquetar_taula(camp="event",taulavariables = conductor_variables) %>% 
  kable(digits = 4,caption = "Descriptiva d'esdeventiment (Complete cases Regicor+QRisc)") %>% kableExtra::kable_styling()

# Summary d'events
map2_df(llistaevents,llista_temps,~resum_events_v3(dades,evento=.x,temps=.y,valorevent=1),.id="event") %>% 
  etiquetar_taula(camp="event",taulavariables = conductor_variables) %>% 
  kable(digits = 4,caption = "Descriptiva d'esdeventiment (Pob TMS)") %>% kableExtra::kable_styling()


# Summary events estratificat per Sexe
dt_temp %>% split(.$sexe,drop = T) %>% map_df(
  function(dt=.x) map2_df(llistaevents,llista_temps,~resum_events_v3(dt,evento=.x,temps=.y,valorevent=1),.id="event"),
  .id="Grup") %>% 
  etiquetar_taula(camp="event",taulavariables = conductor_variables) %>% 
  kable(digits = 4,caption = "Descriptiva d'esdeventiment (Complete cases Regicor+QRisc)") %>% kableExtra::kable_styling()

# Summary events estratificat per Sexe
dades %>% split(.$sexe,drop = T) %>% map_df(
  function(dt=.x) map2_df(llistaevents,llista_temps,~resum_events_v3(dt,evento=.x,temps=.y,valorevent=1),.id="event"),
  .id="Grup") %>% 
  etiquetar_taula(camp="event",taulavariables = conductor_variables) %>% 
  kable(digits = 4,caption = "Descriptiva d'esdeventiment (Pob TMS)") %>% kableExtra::kable_styling()




```

# 4.2. Descriptiva d'events i taxes d'incidència estratificades per grup d'edat

```{r}


# Generar grup de edad
# table(Hmisc::cut2(dt_temp$edat,g=10))
dt_temp<-dades %>% filter(regicor>=0 & QRISK3_2017>=0)
dt_temp<-dt_temp %>% mutate(edat_grup=Hmisc::cut2(edat,g=10))

# Summary events estratificat per Sexe
dt_temp %>% split(.$edat.cat7,drop = T) %>% map_df(
  function(dt=.x) map2_df(llistaevents,llista_temps,~resum_events_v3(dt,evento=.x,temps=.y,valorevent=1),.id="event"),
  .id="Grup") %>% 
  etiquetar_taula(camp="event",taulavariables = conductor_variables) %>% 
  kable(digits = 4,caption = "Descriptiva d'esdeventiment (Complete cases Regicor+QRisc)") %>% kableExtra::kable_styling()


# Summary events estratificat per Sexe
dades %>% split(.$edat.cat7,drop = T) %>% map_df(
  function(dt=.x) map2_df(llistaevents,llista_temps,~resum_events_v3(dt,evento=.x,temps=.y,valorevent=1),.id="event"),
  .id="Grup") %>% 
  etiquetar_taula(camp="event",taulavariables = conductor_variables) %>% 
  kable(digits = 4,caption = "Descriptiva d'esdeventiment (Pob TMS)") %>% kableExtra::kable_styling()





```

# 4.3. Descriptiva d'events i taxes d'incidència estratificades per MEDEA i ruralitat

```{r}

dt_temp<-dades %>% filter(regicor>=0 & QRISK3_2017>=0)

# Summary events estratificat per MEDEA
dt_temp %>% split(.$qmedea,drop=T) %>% map_df(
  function(dt=.x) map2_df(llistaevents,llista_temps,~resum_events_v3(dt,evento=.x,temps=.y,valorevent=1),.id="event"),
  .id="Grup") %>% 
  etiquetar_taula(camp="event",taulavariables = conductor_variables) %>% 
  kable(digits = 4,caption = "Descriptiva d'esdeventiment. (Complete cases Regicor+QRisc)") %>% kableExtra::kable_styling()

# Summary events estratificat per MEDEA
dades %>% split(.$qmedea,drop=T) %>% map_df(
  function(dt=.x) map2_df(llistaevents,llista_temps,~resum_events_v3(dt,evento=.x,temps=.y,valorevent=1),.id="event"),
  .id="Grup") %>% 
  etiquetar_taula(camp="event",taulavariables = conductor_variables) %>% 
  kable(digits = 4,caption = "Descriptiva d'esdeventiment. (Pob TMS)") %>% kableExtra::kable_styling()



# Summary events estratificat per Sexe
dt_temp %>% split(.$ruralitat,drop = T) %>% map_df(
  function(dt=.x) map2_df(llistaevents,llista_temps,~resum_events_v3(dt,evento=.x,temps=.y,valorevent=1),.id="event"),
  .id="Grup") %>% 
  etiquetar_taula(camp="event",taulavariables = conductor_variables) %>% 
  kable(digits = 4,caption = "Descriptiva d'esdeventiment. (Complete cases Regicor+QRisc)") %>% kableExtra::kable_styling()

# Summary events estratificat per Sexe
dades %>% split(.$ruralitat,drop = T) %>% map_df(
  function(dt=.x) map2_df(llistaevents,llista_temps,~resum_events_v3(dt,evento=.x,temps=.y,valorevent=1),.id="event"),
  .id="Grup") %>% 
  etiquetar_taula(camp="event",taulavariables = conductor_variables) %>% 
  kable(digits = 4,caption = "Descriptiva d'esdeventiment. (Pob TMS)") %>% kableExtra::kable_styling()

```

# 4.4. Descriptiva d'events i taxes d'incidència estratificades per categories de regicor Qrisk

```{r}

dt_temp<-dades %>% filter(regicor>=0 & QRISK3_2017>=0)

# Summary events estratificat per QRISK3_2017.cat
dt_temp %>% split(.$QRISK3_2017.cat,drop=T) %>% map_df(
  function(dt=.x) map2_df(llistaevents,llista_temps,~resum_events_v3(dt,evento=.x,temps=.y,valorevent=1),.id="event"),
  .id="Grup") %>% 
  etiquetar_taula(camp="event",taulavariables = conductor_variables) %>% 
  kable(digits = 4,caption = "Descriptiva d'esdeventiment per grup QRISK") %>% kableExtra::kable_styling()

# Summary events estratificat per QRISK3_2017.cat
dades %>% split(.$QRISK3_2017.cat,drop=T) %>% map_df(
  function(dt=.x) map2_df(llistaevents,llista_temps,~resum_events_v3(dt,evento=.x,temps=.y,valorevent=1),.id="event"),
  .id="Grup") %>% 
  etiquetar_taula(camp="event",taulavariables = conductor_variables) %>% 
  kable(digits = 4,caption = "Descriptiva d'esdeventiment per grup QRISK. (Pob TMS)") %>% kableExtra::kable_styling()

# Summary events estratificat per Sexe
dt_temp %>% split(.$regicor.cat,drop=T) %>% map_df(
  function(dt=.x) map2_df(llistaevents,llista_temps,~resum_events_v3(dt,evento=.x,temps=.y,valorevent=1),.id="event"),
  .id="Grup") %>% 
  etiquetar_taula(camp="event",taulavariables = conductor_variables) %>% 
  kable(digits = 4,caption = "Descriptiva d'esdeventiment per grup de REGICOR") %>% kableExtra::kable_styling()

# Summary events estratificat per Sexe
dades %>% split(.$regicor.cat,drop=T) %>% map_df(
  function(dt=.x) map2_df(llistaevents,llista_temps,~resum_events_v3(dt,evento=.x,temps=.y,valorevent=1),.id="event"),
  .id="Grup") %>% 
  etiquetar_taula(camp="event",taulavariables = conductor_variables) %>% 
  kable(digits = 4,caption = "Descriptiva d'esdeventiment per grup de REGICOR. (Pob TMS)") %>% kableExtra::kable_styling()


```

# MERDA A PARTIR DAQUI NO FUNCIONA CORRECTAMENT

```{r}

dt_temp<-dades %>% filter(regicor>=0 & QRISK3_2017>=0)

# Summary events estratificat per QRISK3_2017.cat
dt_temp %>% split(.$QRISK3_2017_catQ,drop=T) %>% map_df(
  function(dt=.x) map2_df(llistaevents,llista_temps,~resum_events_v3(dt,evento=.x,temps=.y,valorevent=1),.id="event"),
  .id="Grup") %>% 
  etiquetar_taula(camp="event",taulavariables = conductor_variables) %>% 
  kable(digits = 4,caption = "Descriptiva d'esdeventiment per grup QRISK") %>% kableExtra::kable_styling()


```



```{r}

dt_temp<-dades %>% filter(regicor>=0 & QRISK3_2017>=0)

# Summary events estratificat per QRISK3_2017.cat
dades %>% split(.$QRISK3_2017_catQ,drop=T) %>% map_df(
  function(dt=.x) map2_df(llistaevents,llista_temps,~resum_events_v3(dt,evento=.x,temps=.y,valorevent=1),.id="event"),
  .id="Grup") %>% 
  etiquetar_taula(camp="event",taulavariables = conductor_variables) %>% 
  kable(digits = 4,caption = "Descriptiva d'esdeventiment per grup QRISK. (Pob TMS)") %>% kableExtra::kable_styling()

# Summary events estratificat per Sexe
dt_temp %>% split(.$regicor_catQ,drop=T) %>% map_df(
  function(dt=.x) map2_df(llistaevents,llista_temps,~resum_events_v3(dt,evento=.x,temps=.y,valorevent=1),.id="event"),
  .id="Grup") %>% 
  etiquetar_taula(camp="event",taulavariables = conductor_variables) %>% 
  kable(digits = 4,caption = "Descriptiva d'esdeventiment per grup de REGICOR") %>% kableExtra::kable_styling()
```

# AQUEST NO EL PRINTA

```{r}

# Summary events estratificat per Sexe
dades %>% split(.$regicor_catQ,drop=T) %>% map_df(
  function(dt=.x) map2_df(llistaevents,llista_temps,~resum_events_v3(dt,evento=.x,temps=.y,valorevent=1),.id="event"),
  .id="Grup") %>% 
  etiquetar_taula(camp="event",taulavariables = conductor_variables) %>% 
  kable(digits = 4,caption = "Descriptiva d'esdeventiment per grup de REGICOR. (Pob TMS)") %>% kableExtra::kable_styling()

```


# 4.5. Descriptiva d'events i taxes d'incidència estratificades per grup d'edat x sexe

### Només event CV


```{r}

cat("MAMAMMAMAMAMAMA")

```


```{r apartat4.5, include=TRUE}

dt_temp<-dades %>% filter(regicor>=0 & QRISK3_2017>=0)

dt_temp<-dt_temp %>% mutate(edat_grup=Hmisc::cut2(edat,g=10), 
                             agrupacio=paste0(sexe,": ",edat.cat7))


# Summary events estratificat per Sexe
dt_temp %>% split(.$agrupacio,drop = T) %>% map_df(
  function(dt=.x) map2_df(llistaevents[1],llista_temps[1],~resum_events_v3(dt,evento=.x,temps=.y,valorevent=1),.id="event"),
  .id="Grup") %>%
  etiquetar_taula(camp="event",taulavariables = conductor_variables) %>%
  kable(digits = 4,caption = "Descriptiva d'esdeventiments per grups d'edat i sexe") %>% kableExtra::kable_styling()


# 
# dades<-dades %>% mutate(edat_grup=Hmisc::cut2(edat,g=10), 
#                             agrupacio=paste0(sexe,": ",edat.cat7))

# Summary events estratificat per Sexe
dades %>% split(.$agrupacio,drop = T) %>% map_df(
  function(dt=.x) map2_df(llistaevents[1],llista_temps[1],~resum_events_v3(dt,evento=.x,temps=.y,valorevent=1),.id="event"),
  .id="Grup") %>%
  etiquetar_taula(camp="event",taulavariables = conductor_variables) %>%
  kable(digits = 4,caption = "Descriptiva d'esdeventiments per grups d'edat i sexe (Pob TMS)") %>% kableExtra::kable_styling()



```

# 4.6. Descriptiva d'events i taxes d'incidència estratificades per grup Medea x sexe

-   Només event CV

```{r apartat4.6., include=TRUE}
# Generar grup de edad

dt_temp<-dades %>% filter(regicor>=0 & QRISK3_2017>=0)

dt_temp<-dt_temp %>% mutate(edat_grup=Hmisc::cut2(edat,g=10), 
                            agrupacio=paste0(sexe,": ",qmedea))

# Summary events estratificat per Sexe
dt_temp %>% split(.$agrupacio,drop = T) %>% map_df(
  function(dt=.x) map2_df(llistaevents[1],llista_temps[1],~resum_events_v3(dt,evento=.x,temps=.y,valorevent=1),.id="event"),
  .id="Grup") %>%
  etiquetar_taula(camp="event",taulavariables = conductor_variables) %>%
  kable(digits = 4,caption = "Descriptiva d'esdeventiments per sexe i medea") %>% kableExtra::kable_styling()



# Generar grup de edad
dades<-dades %>% mutate(edat_grup=Hmisc::cut2(edat,g=10), 
                            agrupacio=paste0(sexe,": ",qmedea))

# Summary events estratificat per Sexe
dades %>% split(.$agrupacio,drop = T) %>% map_df(
  function(dt=.x) map2_df(llistaevents[1],llista_temps[1],~resum_events_v3(dt,evento=.x,temps=.y,valorevent=1),.id="event"),
  .id="Grup") %>%
  etiquetar_taula(camp="event",taulavariables = conductor_variables) %>%
  kable(digits = 4,caption = "Descriptiva d'esdeventiments per sexe i medea (Pob TMS)") %>% kableExtra::kable_styling()

```


# 4.7. Descriptiva d'events i taxes d'incidència estratificades per grup Ruralitat x sexe

-   Només ECV

```{r apartat4.7}
# Generar grup de edad

dt_temp<-dades %>% filter(regicor>=0 & QRISK3_2017>=0)
dt_temp<-dt_temp %>% mutate(edat_grup=Hmisc::cut2(edat,g=10), 
                            agrupacio=paste0(sexe,": ",ruralitat))

llistaevents<-extreure.variables("events",conductor_variables)
llista_temps<-extreure.variables("t_event",conductor_variables)

# Summary events estratificat per Sexe
dt_temp %>% split(.$agrupacio,drop = T) %>% map_df(
  function(dt=.x) map2_df(llistaevents[1],llista_temps[1],~resum_events_v3(dt,evento=.x,temps=.y,valorevent=1),.id="event"),
  .id="Grup") %>%
  etiquetar_taula(camp="event",taulavariables = conductor_variables) %>%
  kable(digits = 4,caption = "Descriptiva d'esdeventiments per sexe i ruralitat") %>% kableExtra::kable_styling()



# Generar grup de edad
dades<-dades %>% mutate(edat_grup=Hmisc::cut2(edat,g=10), 
                            agrupacio=paste0(sexe,": ",ruralitat))

# Summary events estratificat per Sexe
dades %>% split(.$agrupacio,drop = T) %>% map_df(
  function(dt=.x) map2_df(llistaevents[1],llista_temps[1],~resum_events_v3(dt,evento=.x,temps=.y,valorevent=1),.id="event"),
  .id="Grup") %>%
  etiquetar_taula(camp="event",taulavariables = conductor_variables) %>%
  kable(digits = 4,caption = "Descriptiva d'esdeventiments per sexe i ruralitat (Pob TMS)") %>% kableExtra::kable_styling()


```

# 5. Hazard ratio per cada event cardiovascular per QRISK3 i Regicor (global i per sexe)

-   Es seleccionen de dades completes en ambdos indicadors (Qrisk &
    Regicor)
-   Curves ROC y AUC's per cada outcome

```{r output5, eval=FALSE,message=TRUE, warning=TRUE, include=T, echo=FALSE,size="huge", results='asis'}

# genera_output

# llistaevents[1]
# llista_temps[1]
# 
# dt_temp<-dt_temp %>% filter(regicor>=0 & QRISK3_2017>=0)
# genera_output_HR(llistaevents[2],llista_temps[4],dt_temp)


# Filtro dt_temp completes de REGICOR + RQrisk
dt_temp<-dt_temp %>% filter(regicor>=0 & QRISK3_2017>=0)

dt_temp<-dades %>% filter(regicor>=0 & QRISK3_2017>=0)

purrr::map2(llistaevents,llista_temps,~genera_output_HR(.x,.y,dt_temp)) %>% invisible()



# genera_output_HR(llistaevents[4],llista_temps[4],dt_temp)



```

```{r generotaulaHR, include=FALSE}

dt_temp<-dades %>% filter(regicor>=0 & QRISK3_2017>=0)

taula_HR_grup<-function(x_event="EV.CVD",x_temps="EV.CVD_temps",dt=dt_temp,grup="sexe") {
  split(dt,dt[grup]) %>% map_df(~taula_HR(x_event=x_event,x_temps,.x),.id="grup")}



```

# 5.2 Taula resum de hazard ratios per cada event per QRISK3 i Regicor, global i per sexe

```{r,results="asis"}

dt_temp<-dades %>% filter(regicor>=0 & QRISK3_2017>=0)

map2_df(llistaevents,llista_temps,~taula_HR(.x,.y,dt_temp)) %>% 
  kableExtra::kable(caption = "Taula HR per event",digits = 3) %>% kableExtra::kable_styling()

# Estratificat per sexe 
# taula_HR_grup(x_event="EV.CVD",x_temps="EV.CVD_temps",dt=dt_temp,grup="sexe")

map2_df(llistaevents,llista_temps,~taula_HR_grup(.x,.y,dt_temp,grup="sexe")) %>% 
  kableExtra::kable(caption = "Taula HR per event estratificat per sexe",digits = 3) %>% kableExtra::kable_styling()

gc()

```


## AUC resum global i per sexe

```{r}

dt_temp<-dades %>% filter(regicor>=0 & QRISK3_2017>=0)

dt_taula1<-llistaevents %>% map_df(~taula_AUC_R2(.x,dt=dt_temp),.id="Event")

# Per sexe 
dt_taula2<-llistaevents %>% map_df(~taula_AUC_R2_grup(.x,dt=dt_temp,grup = "sexe"),.id="Event")

dt_taula1 %>% kable(caption = "AUC resum global") %>% kableExtra::kable_classic_2()

dt_taula2 %>% kable(caption = "AUC resum per sexe") %>% kableExtra::kable_classic_2()


```

## Models de regressió ajustats de riscos proporcionals de Cox

-   S'ha fet exclusivament amb la N de participants que tenim calculat
    Qrisk i regicor
-   S'ha afegit models amb variabes recodificades

```{r models, results="asis"}

# formulaCOX("model1",event = llistaevents[1],temps = llista_temps[1], a="regicor", taulavariables = conductor_variables) %>% coxph(data=dades) %>% 
#   sjPlot::tab_model()

dt_temp<-dades %>% filter(regicor>=0 & QRISK3_2017>=0)


# Actualitzar llista d'events a processar
events_a_noprocesar<-dt_taula1 %>% filter(is.na(AUC.qrisk)) %>% select(Event) %>% as.character()
llistaevents<-llistaevents[which(llistaevents!=events_a_noprocesar)]
llista_temps<-llista_temps[which(llistaevents!=events_a_noprocesar)]

map2(llistaevents,llista_temps,~formulaCOX("model1",event = .x,temps = .y, a="regicor", taulavariables = conductor_variables)) %>% 
  map(~coxph(.x,data=dt_temp)) %>% 
  sjPlot::tab_model(title = "Modelos de regressión de Cox ajustados. Regicor ajustado")

map2(llistaevents,llista_temps,~formulaCOX("model1",event = .x,temps = .y, a="regicor.cat", taulavariables = conductor_variables)) %>% 
  map(~coxph(.x,data=dt_temp)) %>% 
  sjPlot::tab_model(title = "Modelos de regressión de Cox ajustados. Regicor ajustado")

map2(llistaevents,llista_temps,~formulaCOX("model1",event = .x,temps = .y, a="regicor_catQ", taulavariables = conductor_variables)) %>%   map(~coxph(.x,data=dt_temp)) %>% 
  sjPlot::tab_model(title = "Modelos de regressión de Cox ajustados. Regicor ajustado")


map2(llistaevents,llista_temps,~formulaCOX("model1",event = .x,temps = .y, a="QRISK3_2017", taulavariables = conductor_variables)) %>% 
  map(~coxph(.x,data=dt_temp)) %>% 
  sjPlot::tab_model(title = "Modelos de regressión de Cox ajustdos. Qrisk ajustado")

map2(llistaevents,llista_temps,~formulaCOX("model1",event = .x,temps = .y, a="QRISK3_2017.cat", taulavariables = conductor_variables)) %>% 
  map(~coxph(.x,data=dt_temp)) %>% 
  sjPlot::tab_model(title = "Modelos de regressión de Cox ajustdos. Qrisk ajustado")

map2(llistaevents,llista_temps,~formulaCOX("model1",event = .x,temps = .y, a="QRISK3_2017_catQ", taulavariables = conductor_variables)) %>% 
  map(~coxph(.x,data=dt_temp)) %>% 
  sjPlot::tab_model(title = "Modelos de regressión de Cox ajustdos. Qrisk ajustado")



```

```{r,include=F}

# 4. Descriptiva escales de risk global y per diferents tipus de TMS

dt_temp<-dades %>% filter(regicor>=0 & QRISK3_2017>=0)

varsTMS<-extreure.variables("TMS",conductor_variables)

formu<-formula.text("REGICOR",y="DG.ESQUIZO",taulavariables = conductor_variables)

descrTable(formu,dt_temp, include.miss = T,show.n = T, show.all = T) %>% 
  export2md()

descrTable(formu,dt_temp, method = 2,Q1=0, Q3=1,show.n = T, show.all = T) %>% 
    export2md()


formu<-formula.text("REGICOR",y="DG.ESQUIZO",taulavariables = conductor_variables)

descrTable(formu,dt_temp, include.miss = T,show.n = T, show.all = T) %>% 
  export2md()

descrTable(formu,dt_temp, method = 2,Q1=0, Q3=1,show.n = T, show.all = T) %>% 
    export2md()


formu<-formula.text("REGICOR",y="DG.BIPOLAR_MANIA",taulavariables = conductor_variables)

descrTable(formu,dt_temp, include.miss = T,show.n = T, show.all = T) %>% 
  export2md()

descrTable(formu,dt_temp, method = 2,Q1=0, Q3=1,show.n = T, show.all = T) %>% 
    export2md()


formu<-formula.text("REGICOR",y="DG.ALTRES_PSICOTICS",taulavariables = conductor_variables)

descrTable(formu,dt_temp, include.miss = T,show.n = T, show.all = T) %>% 
  export2md()

descrTable(formu,dt_temp, method = 2,Q1=0, Q3=1,show.n = T, show.all = T) %>% 
    export2md()


formu<-formula.text("REGICOR",y="DG.DEPRESSIO_GREU",taulavariables = conductor_variables)

descrTable(formu,dt_temp, include.miss = T,show.n = T, show.all = T) %>% 
  export2md()

descrTable(formu,dt_temp, method = 2,Q1=0, Q3=1,show.n = T, show.all = T) %>% 
    export2md()




```
